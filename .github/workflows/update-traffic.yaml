name: Update Traffic Stats

on:
  schedule:
    - cron: "0 0 * * *"  # Runs daily at 00:00 UTC
  workflow_dispatch:     # Allow manual runs too

jobs:
  update-traffic:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Install dependencies
        run: |
          pip install requests

      - name: Fetch and save traffic data
        env:
          GITHUB_TOKEN: ${{ secrets.TRAFFIC_UPDATE_TOKEN }}
          REPO: CodingLife1024/Sensor-Controlled-Air-Purifier
        run: |
          import requests, json
          from datetime import datetime

          headers = {
              "Authorization": f"token {os.environ['GITHUB_TOKEN']}",
              "Accept": "application/vnd.github.v3+json"
          }

          views_url = f"https://api.github.com/repos/{os.environ['REPO']}/traffic/views"
          clones_url = f"https://api.github.com/repos/{os.environ['REPO']}/traffic/clones"

          views = requests.get(views_url, headers=headers).json()
          clones = requests.get(clones_url, headers=headers).json()

          now = datetime.utcnow().strftime("%Y-%m-%d %H:%M:%S")
          data = {
              "timestamp": now,
              "views": views,
              "clones": clones
          }

          with open("traffic_stats.json", "a") as f:
              f.write(json.dumps(data) + "\n")

      - name: Commit traffic data
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git add traffic_stats.json
          git commit -m "Update traffic data [skip ci]" || echo "No changes to commit"
          git push
